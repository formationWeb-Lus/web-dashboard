<%- include('../partials/header') %>

<header class="header">
  <!-- Bouton menu pour mobile -->
  <button id="menuToggle" class="menu-toggle">☰</button>

  <!-- Logo principal -->
  <div class="logo">
    <img src="/images/logo.png" alt="Logo GPS RDC">
    <span>GPS RDC</span>
  </div>

  <nav>
    <ul class="nav">
      <li><a href="/dashboard" class="active">📍 Position</a></li>
      <li><a href="/history">📜 Historique</a></li>
      <li><a href="/stop">⛔ Arrêt</a></li>
      <li><a href="/settings">⚙️ Paramètres</a></li>
    </ul>
  </nav>
</header>

<h2 class="section-title">📍 Dernières positions des véhicules</h2>

<!-- Sélecteur de véhicules -->
<div class="select-wrapper" style="text-align:center; margin-bottom:20px;">
  <form method="GET" action="/dashboard">
    <label for="vehSelect">Sélectionner un véhicule : </label>
    <select id="vehSelect" name="v" onchange="this.form.submit()">
      <option value="all" <%= selectedVehicule === 'all' ? 'selected' : '' %>>Tous les véhicules</option>
      <% vehicules.forEach(v => { %>
        <option value="<%= v.vehiculeid %>" <%= selectedVehicule == v.vehiculeid ? 'selected' : '' %>>
          <%= v.vehiculeid %>
        </option>
      <% }) %>
    </select>
  </form>
</div>

<% if (positions.length > 0) { %>
  <table class="positions-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Véhicule</th>
        <th>Quartier</th>
        <th>Rue</th>
        <th>Ville</th>
        <th>Pays</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Vitesse (km/h)</th>
        <th>Date_Heure</th>
      </tr>
    </thead>
    <tbody>
      <% positions.forEach((pos, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= pos.vehiculeid %></td>
          <td><%= pos.quartier || '-' %></td>
          <td><%= pos.rue || '-' %></td>
          <td><%= pos.ville || '-' %></td>
          <td><%= pos.pays || '-' %></td>
          <td><%= pos.latitude %></td>
          <td><%= pos.longitude %></td>
          <td><%= pos.speed || 0 %></td>
          <td><%= new Date(pos.timestamp).toLocaleString() %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } else { %>
  <p style="text-align:center;">Aucune position enregistrée pour le véhicule sélectionné.</p>
<% } %>

<!-- Carte Google Maps -->
<h2 style="margin-top:30px;">🗺️ Carte des véhicules</h2>
<div id="map" style="height: 500px; width: 100%; margin-bottom: 10px;"></div>
<p id="distanceInfo" style="text-align:center;">📏 En attente de la localisation...</p>
<button onclick="locateMe()">📍 Me localiser</button>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCz_VhJ95x-dQl40Ok6cULkxX7K0C8O320"></script>

<script type="module">
  import { initVehicleMap } from '/js/map.js';

  const vehicules = <%- JSON.stringify(vehicules) %>;
  const positions = <%- JSON.stringify(positions) %>;

  initVehicleMap(vehicules, positions, 'map', 'distanceInfo', 'vehSelect');
</script>

<%- include('../partials/footer') %>
