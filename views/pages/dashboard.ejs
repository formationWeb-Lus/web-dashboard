<%- include('../partials/header') %>

<nav>
  <ul class="nav">
    <li><a href="/dashboard" class="active">📍 Position</a></li>
    <li><a href="/history">📜 Historique</a></li>
    <li><a href="/stop">⛔ Arrêt</a></li>
    <li><a href="/settings">⚙️ Paramètres</a></li>
  </ul>
</nav>

<h2>📍 Dernières positions des véhicules</h2>

<!-- Sélecteur de véhicules -->
<div class="select-wrapper" style="text-align:center; margin-bottom:20px;">
  <form method="GET" action="/dashboard">
    <label for="vehSelect">Sélectionner un véhicule : </label>
    <select id="vehSelect" name="v" onchange="this.form.submit()">
      <option value="all" <%= selectedVehicule === 'all' ? 'selected' : '' %>>Tous les véhicules</option>
      <% vehicules.forEach(v => { %>
        <option value="<%= v.vehiculeid %>" <%= selectedVehicule == v.vehiculeid ? 'selected' : '' %>>
          <%= v.vehiculeid %>
        </option>
      <% }) %>
    </select>
  </form>
</div>

<!-- Tableau des positions -->
<% if (positions.length > 0) { %>
  <table class="positions-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Véhicule</th>
        <th>Quartier</th>
        <th>Rue</th>
        <th>Ville</th>
        <th>Pays</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Vitesse (km/h)</th>
        <th>Date_Heure</th>
      </tr>
    </thead>
    <tbody>
      <% positions.forEach((pos, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= pos.vehiculeid %></td>
          <td><%= pos.quartier || '-' %></td>
          <td><%= pos.rue || '-' %></td>
          <td><%= pos.ville || '-' %></td>
          <td><%= pos.pays || '-' %></td>
          <td><%= pos.latitude %></td>
          <td><%= pos.longitude %></td>
          <td><%= pos.speed || 0 %></td>
          <td><%= new Date(pos.timestamp).toLocaleString() %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } else { %>
  <p style="text-align:center;">Aucune position enregistrée pour le véhicule sélectionné.</p>
<% } %>

<!-- Carte Google Maps -->
<h2 style="margin-top:30px;">🗺️ Carte des véhicules</h2>
<div id="map" style="height: 500px; width: 100%; margin-bottom: 10px;"></div>
<p id="distanceInfo" style="text-align:center;">📏 En attente de la localisation...</p>
<button onclick="locateMe()">📍 Me localiser</button>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCz_VhJ95x-dQl40Ok6cULkxX7K0C8O320"></script>

<!-- Ton script map.js -->
<script type="module">
  import { initVehicleMap } from '/js/map.js';

  // Passer directement les positions et véhicules déjà récupérés dans le tableau de bord
  const vehicules = <%- JSON.stringify(vehicules) %>;
  const positions = <%- JSON.stringify(positions) %>;

  // Initialisation de la carte
  initVehicleMap(vehicules, positions, 'map', 'distanceInfo', 'vehSelect');
</script>

<%- include('../partials/footer') %>
