<%- include('../partials/header') %>

<nav>
  <ul class="nav">
    <li><a href="/dashboard">📍 Position</a></li>
    <li><a href="/history">📜 Historique</a></li>
    <li><a href="/stop">⛔ Arrêt</a></li>
    <li><a href="/map" class="active">🗺️ Carte</a></li>
    <li><a href="/settings">⚙️ Paramètres</a></li>
  </ul>
</nav>

<h2>🗺️ Carte des véhicules</h2>

<div class="select-wrapper" style="text-align:center; margin-bottom:10px;">
  <label for="vehSelect">Sélectionner un véhicule : </label>
  <select id="vehSelect">
    <option value="all">Tous les véhicules</option>
    <% vehicules.forEach(v => { %>
      <option value="<%= v.vehiculeid %>" <%= vehicule === v.vehiculeid ? 'selected' : '' %> >
        <%= v.vehiculeid %>
      </option>
    <% }) %>
  </select>
</div>

<div id="map" style="height:500px; width:100%; margin-bottom:10px;"></div>
<p id="distanceInfo" style="text-align:center;">📏 En attente de la localisation...</p>
<button onclick="locateMe()">📍 Me localiser</button>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCz_VhJ95x-dQl40Ok6cULkxX7K0C8O320"></script>

<!-- Front-end map.js -->
<script type="module">
  import { initVehicleMap } from '/js/map.js';

  // Données passées depuis le serveur
  const vehicules = <%- JSON.stringify(vehicules) %>;
  const positions = <%- JSON.stringify(positions) %>;

  // Paramètres du lien (si on vient du tableau de bord)
  const initialVehicule = "<%= vehicule || 'all' %>";
  const initialLat = parseFloat("<%= lat || '0' %>");
  const initialLng = parseFloat("<%= lng || '0' %>");

  // Initialiser la carte
  initVehicleMap(vehicules, positions, 'map', 'distanceInfo', 'vehSelect');

  // Si lien avec coordonnées, recentrer sur le véhicule
  if (initialVehicule !== 'all' && initialLat && initialLng) {
    document.getElementById('vehSelect').value = initialVehicule;
    document.getElementById('vehSelect').dispatchEvent(new Event('change'));
  }
</script>

<%- include('../partials/footer') %>
