<%- include('../partials/header') %>

<nav>
  <ul class="nav">
    <li><a href="/dashboard">ğŸ“ Position</a></li>
    <li><a href="/history">ğŸ“œ Historique</a></li>
    <li><a href="/stop">â›” ArrÃªt</a></li>
    <li><a href="/map" class="active">ğŸ—ºï¸ Carte</a></li>
    <li><a href="/settings">âš™ï¸ ParamÃ¨tres</a></li>
  </ul>
</nav>

<h2>ğŸ—ºï¸ Carte des vÃ©hicules</h2>

<div class="select-wrapper" style="text-align:center; margin-bottom:10px;">
  <label for="vehSelect">SÃ©lectionner un vÃ©hicule : </label>
  <select id="vehSelect">
    <option value="all">Tous les vÃ©hicules</option>
    <% vehicules.forEach(v => { %>
      <option value="<%= v.vehiculeid %>" <%= vehicule === v.vehiculeid ? 'selected' : '' %> >
        <%= v.vehiculeid %>
      </option>
    <% }) %>
  </select>
</div>

<div id="map" style="height:500px; width:100%; margin-bottom:10px;"></div>
<p id="distanceInfo" style="text-align:center;">ğŸ“ En attente de la localisation...</p>
<button onclick="locateMe()">ğŸ“ Me localiser</button>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCz_VhJ95x-dQl40Ok6cULkxX7K0C8O320"></script>

<!-- Front-end map.js -->
<script type="module">
  import { initVehicleMap } from '/js/map.js';

  // DonnÃ©es passÃ©es depuis le serveur
  const vehicules = <%- JSON.stringify(vehicules) %>;
  const positions = <%- JSON.stringify(positions) %>;

  // ParamÃ¨tres du lien (si on vient du tableau de bord)
  const initialVehicule = "<%= vehicule || 'all' %>";
  const initialLat = parseFloat("<%= lat || '0' %>");
  const initialLng = parseFloat("<%= lng || '0' %>");

  // Initialiser la carte
  initVehicleMap(vehicules, positions, 'map', 'distanceInfo', 'vehSelect');

  // Si lien avec coordonnÃ©es, recentrer sur le vÃ©hicule
  if (initialVehicule !== 'all' && initialLat && initialLng) {
    document.getElementById('vehSelect').value = initialVehicule;
    document.getElementById('vehSelect').dispatchEvent(new Event('change'));
  }
</script>

<%- include('../partials/footer') %>
