<%- include('../partials/header') %>

<nav>
  <ul class="nav">
    <li><a href="/dashboard">ğŸ“ Position</a></li>
    <li><a href="/history">ğŸ“œ Historique</a></li>
    <li><a href="/stops" class="active">â›” ArrÃªt</a></li>
    <li><a href="/map">ğŸ—ºï¸ Carte</a></li>
    <li><a href="/settings">âš™ï¸ ParamÃ¨tres</a></li>
  </ul>
</nav>

<h2>â›” ArrÃªts du vÃ©hicule</h2>

<div class="select-wrapper" style="text-align:center; margin-bottom:10px;">
  <label for="vehSelect">SÃ©lectionner un vÃ©hicule : </label>
  <select id="vehSelect">
    <option value="">-- Choisissez un vÃ©hicule --</option>
    <% vehicules.forEach(v => { %>
      <option value="<%= v.vehiculeid %>"><%= v.vehiculeid %></option>
    <% }) %>
  </select>
</div>

<table border="1" style="width:100%; text-align:center;">
  <thead>
    <tr>
      <th>Quartier</th>
      <th>Rue</th>
      <th>NumÃ©ro</th>
      <th>Heure de dÃ©but</th>
      <th>Heure de fin</th>
      <th>DurÃ©e (min)</th>
    </tr>
  </thead>
  <tbody id="stopTableBody">
    <tr>
      <td colspan="6">SÃ©lectionnez un vÃ©hicule pour voir ses arrÃªts</td>
    </tr>
  </tbody>
</table>

<script>
  const vehSelect = document.getElementById('vehSelect');
  const stopTableBody = document.getElementById('stopTableBody');

  vehSelect.addEventListener('change', async function() {
    const vehiculeId = this.value;

    if (!vehiculeId) {
      stopTableBody.innerHTML = `<tr><td colspan="6">Veuillez sÃ©lectionner un vÃ©hicule spÃ©cifique.</td></tr>`;
      return;
    }

    try {
      // âœ… corrige lâ€™URL : /stops/:vehiculeId
      const res = await fetch(`/stops/${vehiculeId}`);
      const data = await res.json();

      if (!data.stops || data.stops.length === 0) {
        stopTableBody.innerHTML = `<tr><td colspan="6">Aucun arrÃªt enregistrÃ© pour ce vÃ©hicule aujourd'hui.</td></tr>`;
        return;
      }

      stopTableBody.innerHTML = '';
      data.stops.forEach(s => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${s.quartier || '-'}</td>
          <td>${s.rue || '-'}</td>
          <td>${s.numero || '-'}</td>
          <td>${new Date(s.start).toLocaleTimeString()}</td>
          <td>${new Date(s.end).toLocaleTimeString()}</td>
          <td>${s.duration}</td>
        `;
        stopTableBody.appendChild(row);
      });
    } catch (err) {
      console.error('Erreur fetch stops:', err);
      stopTableBody.innerHTML = `<tr><td colspan="6">Erreur lors du chargement des arrÃªts.</td></tr>`;
    }
  });
</script>

<%- include('../partials/footer') %>
